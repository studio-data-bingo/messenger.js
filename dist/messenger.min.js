/*
* messenger.js 0.3
* MIT licensed
*
* Copyright (C) 2020 Bastien DIDIER, https://data.bingo
*/
class Messenger{constructor({container:e,automaticScroll:t,speed:n}={container:"body",automaticScroll:!0,speed:0}){this.container=e,this.id=this.generateId("messenger"),$(this.container).append(`<ul id="${this.id}" class="messenger"><li class="user sender receiver hidden"></li></ul>`),this.manager=new Manager,this.speed=n,this.scrollSpeed=this.speed>100?this.speed-50:50,this.automaticScroll=t,this.remove={loader:()=>{this.append(null)},message:e=>{console.warn("Removing message isn't possible for the moment - id : "+e)}};const l=this;document.addEventListener("messenger",function(e){l[e.detail.user][e.detail.type](e.detail.content,{comment:e.detail.comment,callback:e.detail.callback})},!1)}get sender(){return this.user="sender",this}get receiver(){return this.user="receiver",this}get application(){return this.user="application",this}append(e,{comment:t,callback:n}={comment:null,callback:null}){const l=e?this.surround(e+this.comment(t)):null,i=this;this.manager.enqueue(()=>{i.removeLoader(),l&&$("#"+i.id).append(l),i.automaticScroll&&i.smoothScroll(),n instanceof Function&&n()},this.speed)}surround(e){return`<li class="user ${this.user}">${e}</li>`}comment(e){return null!=e?`<p class="comment">${e}</p>`:""}smoothScroll(){$("html, body, "+this.container).animate({scrollTop:$(document).height()},this.scrollSpeed)}generateId(e){let t=Math.floor(65536*(1+Math.random())).toString(16).substring(1);if(e){for(;$("#"+e+"-"+t).length;)console.warn("#"+e+"-"+t+" already exist"),t=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return e+"-"+t}return t}remove(e){$(e).parent().remove()}update(e,t,n,{comment:l,callback:i}={comment:null,callback:null}){"text"==t?($(e).html(n),l&&$(e).parent().append(this.comment(l))):console.error("The type "+t+" isn't supported in the update methode")}text(e,{comment:t,callback:n}={comment:null,callback:null}){const l=this.generateId("text"),i=`<p id="${l}" class="content">${e}</p>`;this.append(i,{comment:t,callback:()=>{if(n instanceof Function)return n($("#"+l)[0])}})}image(e,{comment:t,callback:n}={comment:null,callback:null}){const l=this.generateId("image"),i=`<img id="${l}" src="${e}"/>`;this.append(i,{comment:t,callback:()=>{if(n instanceof Function)return n($("#"+l)[0])}})}link({url:e,title:t,source:n,img:l},{comment:i,callback:a}={comment:null,callback:null}){const s=this.generateId("link"),c=`<div id="${s}" class="link">`+`   <a href="${e}" target="_blank">`+(null!=l?`<img src="${l}">`:"")+'       <div class="content">'+`           <p class="source">${n}</p>`+`           <p class="title">${t}</p>`+"        </div>   </a></div>";this.append(c,{comment:i,callback:()=>{if(a instanceof Function)return a($("#"+s)[0])}})}card({title:e,subtitle:t,description:n,url:l,img:i},{comment:a,callback:s}={comment:null,callback:null}){const c=this.generateId("card"),o=`<div id="${c}" class="card">`+(null!=i?`<img src="${i}">`:"")+`   <div class="content${null!=l?" hasAction":""}">`+`       <p class="title">${e}</p>`+(null!=t?`<p class="subtitle">${t}</p>`:"")+`       <p class="description">${n}</p>`+"   </div>"+(null!=l?'<div class="action content">'+`       <p><a href="${l}" target="_blank">En savoir plus</a></p>`+"   </div>":"")+"</div>";this.append(o,{comment:a,callback:()=>{if(s instanceof Function)return s($("#"+c)[0])}})}postal({title:e,subtitle:t,description:n,url:l,img:i},{comment:a,callback:s}={comment:null,callback:null}){const c=this.generateId("postal"),o=`<div id="${c}" class="postal">`+`   <div class="content${null!=i?" hasImage":""}">`+"       <div>"+`           <p class="title">${e}</p>`+(null!=t?`<p class="subtitle">${t}</p>`:"")+`           <p class="description">${n}</p>`+(null!=l?`<p class="action"><a href="${l}" target="_blank">En savoir plus</a></p>`:"")+"       </div>"+(null!=i?`<img src="${i}">`:"")+"   </div></div>";this.append(o,{comment:a,callback:()=>{if(s instanceof Function)return s($("#"+c)[0])}})}list(e=null,t,{comment:n,callback:l}={comment:null,callback:null}){let i=[];t.forEach(e=>{i.push(this.listItem(e))});const a=this.generateId("list"),s=`<div id="${a}" class="list">`+`   <p class="title">${e}</p>`+"   <ul>"+i.join("")+"   </ul></div>";this.append(s,{comment:n,callback:()=>{if(l instanceof Function)return l($("#"+a)[0])}})}listItem({primary:e,secondary:t,img:n}={secondary:null,img:null}){return`<li ${null!=n?'class="hasImage"':""}>`+"   <div>"+`       <p class="primary">${e}</p>`+(null!=t?`<p class="secondary">${t}</p>`:"")+"   </div>"+(null!=n?`   <img src="${n}">`:"")+"</li>"}audio(e,{comment:t,callback:n}={comment:null,callback:null}){const l=this.generateId("audio"),i=`<audio id="${l}" controls="controls" preload="auto">`+`    <source src="${e}" type="audio/mp3" />`+"</audio>";this.append(i,{comment:t,callback:()=>{if(n instanceof Function)return n($("#"+l)[0])}})}video(e,{comment:t,callback:n}={comment:null,callback:null}){const l=this.generateId("video"),i=`<div id="${l}" class="video">`+`   <iframe width="560" height="315" src="${e}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`+"</div>";this.append(i,{comment:t,callback:()=>{if(n instanceof Function)return n($("#"+l)[0])}})}canvas({comment:e,callback:t}={comment:null,callback:null}){const n=this.generateId("canvas"),l=`<canvas id="${n}" width="560" height="315"></canvas>`;this.append(l,{comment:e,callback:()=>{if(t instanceof Function){const e=$("#"+n)[0],l=e.getContext("2d");return t(e,l)}}})}webcam({comment:e,callback:t}={comment:null,callback:null}){const n=this.generateId("webcam"),l='<video id="'+n+'" autoplay="true" width="400" height="300"></video><div class="webcam-button" id="button-'+n+'"></div>';this.append(l,{comment:e,callback:()=>{if(t instanceof Function){const e=$("#"+n)[0],l=$("#button-"+n)[0];let i;navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(n){return e.srcObject=n,t(e,i=n,l)}).catch(function(e){console.error(e)})}}})}snapshoot(e){const t=document.createElement("canvas");t.width=300,t.height=300,t.getContext("2d").drawImage(e,-50,0,400,300),this.image(t.toDataURL())}loader(){this.append('<div id="'+this.user+'-loader" class="content loader">    <div class="loader-dots">        <div class="loader-dot"></div>        <div class="loader-dot"></div>        <div class="loader-dot"></div>    </div></div>')}removeLoader(){$("#"+this.user+"-loader").parent().remove()}}class Manager{constructor(){this.timer,this.items=[]}enqueue(e,t){this.items.push({callback:e,delay:t}),this.timer||this.launch()}dequeue(){return this.items.shift()}remove(e){delete this.items[e]}clear(){this.timer&&clearTimeout(this.timer),this.timer=null,this.items.length=0}isEmpty(){return 0==this.items.length}next(){return this.isEmpty()?void 0:this.items[0]}length(){return this.items.length}launch(){if(this.timer)return;let e=this.dequeue();if(!e)return this.clear();var t=this;this.timer=setTimeout(function(){e.callback.call(),t.timer=null,t.launch()},e.delay)}print(){return this.isEmpty()?void 0:this.items}}